using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;
using oo;

namespace ToDoList
{
    public partial class gate : Form
    {
        // Deklarasi Variabel
        string connectionString = "Server=localhost;Database=todolist;Uid=root;Pwd=;";
        MySqlConnection connection;
        private bool _userHasTypedUsername = false;
        private bool _userHasTypedPassword = false;

        // Konstruktor
        public gate()
        {
            InitializeComponent();
            InitializeForm();
        }

        // Inisialisasi Form
        private void InitializeForm()
        {
            connection = new MySqlConnection(connectionString);
            lblUsernameWarn.Visible = false;
            lblPasswordWarn.Visible = false;
            textBox2.UseSystemPasswordChar = true;
        }

        // ==================== EVENT HANDLERS ====================

        // 1. Username Text Changed
        private void textBox1_TextChanged(object sender, EventArgs e)
        {
            if (textBox1.Text.Length > 0)
            {           
                _userHasTypedUsername = true;
                lblUsernameWarn.Visible = false;
            }

            if (_userHasTypedUsername && textBox1.Text.Length == 0)
                lblUsernameWarn.Visible = true;
        }

        // 2. Password Text Changed
        private void textBox2_TextChanged(object sender, EventArgs e)
        {
            if (textBox2.Text.Length > 0)
            {
                _userHasTypedPassword = true;
                lblPasswordWarn.Visible = false;
            }

            if (_userHasTypedPassword && textBox2.Text.Length == 0)
                lblPasswordWarn.Visible = true;
        }

        // 3. Show Password Checkbox
        private void checkBoxPw_CheckedChanged(object sender, EventArgs e)
        {
            textBox2.UseSystemPasswordChar = !checkBoxPw.Checked;
        }

        // 4. Login Button
        private void btnLogin_Click(object sender, EventArgs e)
        {
            string username = textBox1.Text.Trim();
            string password = textBox2.Text.Trim();

            // Validasi Input
            if (string.IsNullOrEmpty(username))
            {
                MessageBox.Show("Username harus di isi!", "Peringatan", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                textBox1.Focus();
                return;
            }

            if (string.IsNullOrEmpty(password))
            {
                MessageBox.Show("Password harus di isi!", "Peringatan", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                textBox2.Focus();
                return;
            }

            // Authentication
            AuthenticateUser(username, password);
        }

        // ==================== DATABASE OPERATIONS ====================

        private void AuthenticateUser(string username, string password)
        {
            connection.Open();
            string query = "SELECT nama_lengkap FROM users WHERE username = @user AND password = @pass";
            MySqlCommand cmd = new MySqlCommand(query, connection);
            cmd.Parameters.AddWithValue("@user", username);
            cmd.Parameters.AddWithValue("@pass", password);
            object result = cmd.ExecuteScalar();
            connection.Close();

            if (result != null)
            {
                string namaLengkap = result.ToString();
                MessageBox.Show("Login Berhasil! Selamat Datang, " + namaLengkap);

                todoList mainForm = new todoList(namaLengkap);
                mainForm.Show();
                this.Hide(); // Sembunyikan form login
            }
            else
            {
                MessageBox.Show("Username atau Password salah!", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);  
            }
        }

        // Open TodoList Form
        

        // ==================== PLACEHOLDER METHODS ====================

        private void lblUsernameWarn_Click(object sender, EventArgs e) { }
        private void lblPasswordWarn_Click(object sender, EventArgs e) { }
    }   
}