using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using MySql.Data.MySqlClient;
using System.Media;
using ToDoList;

namespace oo
{
    public partial class todoList : Form
    {
        // Deklarasi Variabel
        string connectionString = "Server=localhost;Database=todolist;Uid=root;Pwd=;";
        MySqlConnection connection;
        DataTable todoTable;
        int currentId = 0;
        bool isEditing = false;

        // Konstruktor
        public todoList(string namaLengkap)
        {
            InitializeComponent();
            InitializeComponents(namaLengkap);
        }

        // Inisialisasi Komponen
        private void InitializeComponents(string namaLengkap)
        {
            connection = new MySqlConnection(connectionString);
            lbluser.Text = "Halo, " + namaLengkap;

            // Event Handlers
            todoListView.CellContentClick += todoListView_CellContentClick;
            todoListView.SelectionChanged += todoListView_SelectionChanged;
            todoListView.CellFormatting += todoListView_CellFormatting;
        }

        // Form Load Event
        private void todoList_Load(object sender, EventArgs e)
        {
            LoadData();
            SetButtonsVisibility(false);
        }

        // ==================== DATABASE OPERATIONS ====================

        // 1. Load Data dari Database
        private void LoadData()
        {
            connection.Open();
            string query = "SELECT id, Judul, Deskripsi, finished_at AS 'Selesai Pada' FROM todos ORDER BY created_at DESC";
            MySqlDataAdapter adapter = new MySqlDataAdapter(query, connection);
            todoTable = new DataTable();
            adapter.Fill(todoTable);
            SetupDataGridView();
            connection.Close();
        }

        // 2. Setup DataGridView
        private void SetupDataGridView()
        {
            todoListView.DataSource = null;
            todoListView.Columns.Clear();
            todoListView.AllowUserToAddRows = false;

            // Tambah Kolom Checkbox Status
            DataGridViewCheckBoxColumn checkColumn = new DataGridViewCheckBoxColumn();
            checkColumn.Name = "Status";
            checkColumn.HeaderText = "Status";
            checkColumn.Width = 50;
            checkColumn.ReadOnly = false;
            todoListView.Columns.Add(checkColumn);

            // Set DataSource
            todoListView.DataSource = todoTable;

            // Sembunyikan Kolom ID
            if (todoListView.Columns["id"] != null)
                todoListView.Columns["id"].Visible = false;

            // Atur Lebar Kolom
            if (todoListView.Columns["Judul"] != null) todoListView.Columns["Judul"].Width = 200;
            if (todoListView.Columns["Deskripsi"] != null) todoListView.Columns["Deskripsi"].Width = 300;
            if (todoListView.Columns["Selesai Pada"] != null) todoListView.Columns["Selesai Pada"].Width = 150;
        }

        // 3. Execute Query Helper
        private void ExecuteQuery(string query, params MySqlParameter[] parameters)
        {
            connection.Open();
            MySqlCommand cmd = new MySqlCommand(query, connection);
            if (parameters != null) cmd.Parameters.AddRange(parameters);
            cmd.ExecuteNonQuery();
            connection.Close();
        }

        // ==================== UI HELPER METHODS ====================

        // 1. Visibilitas Tombol
        private void SetButtonsVisibility(bool visible)
        {
            btnEdit.Visible = visible;
            btnDelete.Visible = visible;
        }

        // 2. Clear Input Fields
        private void ClearFields()
        {
            txtboxJudul.Text = "";
            txtboxDeskripsi.Text = "";
            isEditing = false;
            currentId = 0;
            todoListView.ClearSelection();
        }

        // ==================== DATA GRID VIEW EVENTS ====================

        // 1. Selection Changed
        private void todoListView_SelectionChanged(object sender, EventArgs e)
        {
            if (todoListView.CurrentCell != null && todoListView.CurrentCell.RowIndex >= 0)
                SetButtonsVisibility(true);
            else
                SetButtonsVisibility(false);
        }

        // 2. Cell Formatting
        private void todoListView_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            if (e.RowIndex >= 0 && e.RowIndex < todoListView.Rows.Count)
            {
                DataGridViewRow gridRow = todoListView.Rows[e.RowIndex];
                DataRowView dataRow = gridRow.DataBoundItem as DataRowView;

                if (dataRow != null)
                {
                    // Set Checkbox Status
                    if (todoListView.Columns[e.ColumnIndex].Name == "Status")
                    {
                        bool isFinished = dataRow["Selesai Pada"] != DBNull.Value;
                        e.Value = isFinished;
                    }

                    // Set Warna Baris
                    if (dataRow["Selesai Pada"] != DBNull.Value)
                        gridRow.DefaultCellStyle.BackColor = Color.LightGreen;
                    else
                        gridRow.DefaultCellStyle.BackColor = Color.White;
                }
            }
        }

        // 3. Cell Content Click (Checkbox)
        private void todoListView_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0 && todoListView.Columns[e.ColumnIndex].Name == "Status")
            {
                todoListView.CommitEdit(DataGridViewDataErrorContexts.Commit);
                DataRowView row = (DataRowView)todoListView.Rows[e.RowIndex].DataBoundItem;
                int id = Convert.ToInt32(row["id"]);
                bool isChecked = (bool)todoListView.Rows[e.RowIndex].Cells["Status"].Value;

                if (isChecked)
                {
                    SoundPlayer audio = new SoundPlayer("C:\\Users\\g\\Documents\\belajar\\CODE\\c#\\ToDoList\\Fully\\oo\\bin\\Debug\\boom.wav");
                    audio.Play();
                }

                string query = isChecked
                    ? "UPDATE todos SET finished_at = NOW() WHERE id = @id"
                    : "UPDATE todos SET finished_at = NULL WHERE id = @id";

                ExecuteQuery(query, new MySqlParameter("@id", id));
                LoadData();
            }
        }

        // ==================== BUTTON EVENT HANDLERS ====================

        // 1. Save Button (Insert/Update)
        private void btnSave_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtboxJudul.Text)) return;

            string query = isEditing
                ? "UPDATE todos SET Judul = @judul, Deskripsi = @deskripsi WHERE id = @id"
                : "INSERT INTO todos (Judul, Deskripsi) VALUES (@judul, @deskripsi)";

            MySqlCommand cmd = new MySqlCommand(query, connection);
            cmd.Parameters.AddWithValue("@judul", txtboxJudul.Text);
            cmd.Parameters.AddWithValue("@deskripsi", txtboxDeskripsi.Text);
            if (isEditing) cmd.Parameters.AddWithValue("@id", currentId);

            connection.Open();
            cmd.ExecuteNonQuery();
            connection.Close();

            ClearFields();
            LoadData();
        }

        // 2. Edit Button
        private void btnEdit_Click(object sender, EventArgs e)
        {
            if (todoListView.CurrentRow != null)
            {
                int rowIndex = todoListView.CurrentCell.RowIndex;
                currentId = Convert.ToInt32(todoTable.Rows[rowIndex]["id"]);
                txtboxJudul.Text = todoTable.Rows[rowIndex]["Judul"].ToString();
                txtboxDeskripsi.Text = todoTable.Rows[rowIndex]["Deskripsi"].ToString();
                isEditing = true;
            }
        }

        // 3. Delete Button
        private void btnDelete_Click(object sender, EventArgs e)
        {
            if (todoListView.CurrentRow != null)
            {
                int rowIndex = todoListView.CurrentCell.RowIndex;
                int id = Convert.ToInt32(todoTable.Rows[rowIndex]["id"]);

                DialogResult dialogResult = MessageBox.Show("Yakin ingin menghapus?", "Konfirmasi", MessageBoxButtons.YesNo);
                if (dialogResult == DialogResult.Yes)
                {
                    string query = "DELETE FROM todos WHERE id = @id";
                    ExecuteQuery(query, new MySqlParameter("@id", id));
                    ClearFields();
                    LoadData();
                }
            }
        }

        // 4. Logout Button
        private void btnLogout_Click(object sender, EventArgs e)
        {
            DialogResult result = MessageBox.Show("Apakah Anda yakin ingin logout?", "Konfirmasi Logout", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (result == DialogResult.Yes)
            {
                gate loginForm = new gate();
                loginForm.Show();
                this.Dispose();
            }
        }

        // ==================== SEARCH FUNCTIONALITY ====================

        private void txtboxSearch_TextChanged(object sender, EventArgs e)
        {
            if (todoTable != null)
            {
                string keyword = txtboxSearch.Text.Replace("'", "''");
                todoTable.DefaultView.RowFilter = string.Format("Judul LIKE '%{0}%' OR Deskripsi LIKE '%{0}%'", keyword);
            }
        }

        // ==================== PLACEHOLDER METHODS ====================

        private void lbluser_Click(object sender, EventArgs e) { }
    }
}